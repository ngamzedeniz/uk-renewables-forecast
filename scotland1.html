<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scotland Renewable Forecast Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: row; height: 100vh; }
    #map { width: 50%; height: 100%; }
    #right { width: 50%; padding: 20px; display: flex; flex-direction: column; }
    #right select { margin-bottom: 10px; padding: 5px; }
    canvas { flex: 1; }
    #insight { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="right">
    <h2>Live Satellite & Solar Forecast</h2>
    <label for="satSelect">Choose satellite layer:</label>
    <select id="satSelect">
      <option value="MODIS_Terra_CorrectedReflectance_TrueColor">MODIS True Color</option>
      <option value="VIIRS_SNPP_CorrectedReflectance_TrueColor">VIIRS True Color</option>
      <option value="MODIS_Terra_CorrectedReflectance_Bands721">MODIS False Color (Bands 7-2-1)</option>
    </select>
    <canvas id="forecastChart"></canvas>
    <div id="insight"></div>
  </div>

<script>
// Initialize map
const map = L.map('map').setView([56.5, -3], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let satLayer;
function updateSat(layerName) {
  if (satLayer) {
    map.removeLayer(satLayer);
  }
  const dateStr = new Date().toISOString().slice(0,10);
  satLayer = L.tileLayer(
    `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${layerName}/default/${dateStr}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
    { attribution: 'NASA GIBS' }
  );
  satLayer.addTo(map);
}
document.getElementById('satSelect').onchange = (e) => {
  updateSat(e.target.value);
};
// Default satellite layer
updateSat(document.getElementById('satSelect').value);

// Fetch solar radiation data from Open-Meteo
async function fetchSatelliteRadiation(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=shortwave_radiation&forecast_days=1`;
  const resp = await fetch(url);
  return resp.json();
}

// Plot chart with Chart.js
async function loadForecast() {
  const lat = 56.5, lon = -3;
  const satData = await fetchSatelliteRadiation(lat, lon);
  const hours = satData.hourly.time.map(t => t.slice(11,16)); // only HH:MM
  const rad = satData.hourly.shortwave_radiation;

  const ctx = document.getElementById('forecastChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: hours,
      datasets: [{
        label: 'Solar Radiation (W/m²)',
        data: rad,
        borderColor: 'orange',
        backgroundColor: 'rgba(255,165,0,0.3)',
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Hour (UTC)' } },
        y: { title: { display: true, text: 'Radiation (W/m²)' } }
      }
    }
  });

  // Simple insight
  const avgRad = rad.reduce((a,b)=>a+b,0) / rad.length;
  document.getElementById('insight').innerText =
    avgRad < 100 ? "⚠️ Low solar radiation expected → potential supply risk" :
    "✅ Normal solar conditions";
}
loadForecast();
</script>

</body>
</html>
